<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ប្រព័ន្ធគ្រប់គ្រងសាលារៀន</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#3963de">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/appicon.PNG">
    <link rel="apple-touch-icon" href="icons/appicon.PNG">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>


    <style>
        :root {
            --primary-color: #3963de;
            --secondary-color: #ffffff;
            --background-color: #f0f2f5;
            --text-dark: #0A192F;
            --text-secondary: #5A677B;
            --text-light: #ffffff;
            --border-color: #e0eaf3;
            --error-color: #e53e3e;
            --success-color: #10B981;
            --notification-color: #f56565;
            --gold-color: #ffd700;
            --silver-color: #c0c0c0;
            --bronze-color: #cd7f32;
            --status-present-color: #10B981;
            --status-absent-color: #e53e3e;
            --status-leave-color: #f59e0b;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { height: 100%; }
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            -webkit-font-smoothing: antialiased;
            background: var(--background-color);
            color: var(--text-dark);
            height: 100dvh;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        .hidden { display: none !important; }

        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px); display: flex; justify-content: center;
            align-items: center; z-index: 4000; transition: opacity 0.3s ease;
        }
        .loader-content { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        .loader-spinner { display: flex; gap: 0.75rem; }
        .loader-spinner div {
            width: 15px; height: 15px; background-color: var(--primary-color);
            border-radius: 50%; animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-spinner .dot1 { animation-delay: -0.32s; }
        .loader-spinner .dot2 { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }
        .loader-text-main { font-size: 1.2rem; font-weight: 600; color: var(--primary-color); }
        .loader-text-sub { font-size: 0.9rem; color: var(--text-secondary); }

        .login-container {
            width: 100%; height: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: linear-gradient(160deg, #4e75f2, #2a52be);
            padding: 2rem; color: var(--text-light);
        }
        .login-header { text-align: center; margin-bottom: 3rem; }
        .login-logo { width: 120px; height: 120px; border-radius: 24px; object-fit: cover; margin: 0 auto 1.5rem auto; }
        .login-school-name { font-size: 1.5rem; font-weight: 700; line-height: 1.3; }
        .login-app-title { font-size: 1.5rem; font-weight: 700; margin-top: 0.25rem; }
        .login-form-container { width: 100%; max-width: 350px; }
        .login-prompt { font-size: 1rem; color: rgba(255, 255, 255, 0.8); margin-bottom: 1.5rem; text-align: center; }
        .input-group { position: relative; margin-bottom: 1.25rem; }
        .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); }
        .login-form input {
            width: 100%; padding: 1rem 1rem 1rem 2.75rem; border-radius: 10px;
            border: 1px solid transparent; font-family: 'Kantumruy Pro', sans-serif;
            font-size: 1rem; background-color: rgba(255, 255, 255, 0.9); color: var(--text-dark);
        }
        #login-error {
            background-color: rgba(255, 82, 82, 0.2); color: #ff5252; margin-bottom: 1rem;
            text-align: center; font-weight: 600; padding: 0.75rem; border-radius: 8px;
        }
        .login-button-wrapper { display: flex; justify-content: center; }
        
        #login-button {
            width: 100%; height: 56px; padding: 1rem; border: none;
            background: linear-gradient(45deg, #fff, #f9f9f9);
            color: var(--primary-color);
            font-size: 1.1rem; font-weight: 700; border-radius: 12px; cursor: pointer;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            box-shadow: 0 4px 15px rgba(0,0,0, 0.1);
            position: relative;
            overflow: hidden;
        }
        #login-button:hover:not(.loading) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(57, 99, 222, 0.3);
        }
        #login-button.loading {
            width: 56px;
            border-radius: 50%;
            pointer-events: none;
            color: transparent;
        }

        #login-button .btn-text { transition: opacity 0.2s ease, transform 0.2s ease; }
        #login-button.loading .btn-text { opacity: 0; transform: scale(0.8); }
        #login-button .spinner { opacity: 0; transform: scale(0); transition: opacity 0.3s ease 0.2s, transform 0.3s ease 0.2s; }
        #login-button.loading .spinner { opacity: 1; transform: scale(1); }
        .login-footer { position: absolute; bottom: 2rem; left: 0; right: 0; text-align: center; font-size: 0.8rem; color: rgba(255, 255, 255, 0.8); }
        .spinner {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 28px; height: 28px; border: 3px solid rgba(57, 99, 222, 0.3);
            border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .page-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column; overflow: hidden;
            background-color: var(--background-color); position: relative;
        }
        .page { width: 100%; height: 100%; display: flex; flex-direction: column; }

        .header {
            background-color: var(--primary-color); color: var(--text-light); padding: 0.75rem 1rem;
            display: flex; justify-content: space-between; align-items: center;
            flex-shrink: 0; min-height: 85px;
        }
        .header-side { display: flex; align-items: center; gap: 1rem; flex-shrink: 0; width: 70px; }
        .header-side:first-child { justify-content: flex-start; }
        .header-side:last-child { justify-content: flex-end; }
        .header-side .logo { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background-color: var(--text-light); }
        .header-side i { font-size: 1.45rem; cursor: pointer; }
        #back-button { font-size: 1.6rem; }
        .school-title-block {
            flex-grow: 1; min-width: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; text-align: center; margin: 0 0.5rem;
        }
        .school-title-block h1 { font-size: clamp(1rem, 3.5vw, 1.2rem); font-weight: 700; line-height: 1.3; }
        #page-title { font-size: 1.2rem; font-weight: 700; }
        .school-title-block p { font-size: 0.85rem; color: rgba(255, 255, 255, 0.8); margin-top: 0.2rem; white-space: nowrap; }

        main {
            flex-grow: 1; display: flex; flex-direction: column;
            overflow-y: auto; overflow-x: hidden; padding: 1rem;
            position: relative; -webkit-overflow-scrolling: touch;
        }
        main::-webkit-scrollbar { display: none; }
        main { -ms-overflow-style: none; scrollbar-width: none; }
        #dashboard-content { display: flex; flex-direction: column; gap: 1rem; height: 100%; }

        .user-profile-bar {
            background-color: var(--secondary-color); display: flex; align-items: center;
            justify-content: space-between; padding: 1.25rem; gap: 1rem;
            border-radius: 12px; cursor: pointer; flex-shrink: 0; border: 1px solid var(--primary-color);
        }
        .user-info { display: flex; align-items: center; gap: 1rem; }
        .user-photo {
            width: 65px; height: 65px; border-radius: 50%; background-color: var(--border-color);
            display: flex; align-items: center; justify-content: center; font-size: 2.5rem;
            color: var(--text-secondary); flex-shrink: 0; overflow: hidden; border: 2px solid var(--primary-color);
        }
        .user-photo img { width: 100%; height: 100%; object-fit: cover; }
        .user-details h2 { font-size: clamp(1.2rem, 3vh, 1.3rem); font-weight: 700; color: var(--primary-color); margin-bottom: 0.35rem; }
        .user-details p { font-size: clamp(0.9rem, 2.3vh, 1rem); color: var(--text-secondary); }
        .teacher-stats { display: flex; gap: 1.25rem; text-align: center; }
        .stat-item .count { font-size: clamp(1.2rem, 3vh, 1.3rem); font-weight: 700; color: var(--primary-color); display: block; }
        .stat-item span:not(.count) { font-size: clamp(0.7rem, 1.7vh, 0.75rem); color: var(--text-secondary); }

        .feature-menu {
            display: grid; grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        .menu-item {
            background: var(--secondary-color); border-radius: 12px; border: 1px solid var(--primary-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; padding: 1rem 0.5rem;
            aspect-ratio: 1 / 1;
        }
        .menu-item:hover { transform: translateY(-4px); box-shadow: 0 4px 15px rgba(0,0,0,0.08); }
        .menu-item i { font-size: clamp(1.8rem, 4vh, 2.2rem); color: var(--primary-color); margin-bottom: 0.75rem; }
        .menu-item span { font-size: clamp(0.7rem, 1.8vh, 0.75rem); font-weight: 600; color: var(--text-secondary); }
        
        .qr-page-button {
            width: 100%;
            max-width: 300px;
            margin: 0 auto 0.75rem auto;
            padding: 0.9rem 1rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            border: 1px solid transparent;
            font-size: 1rem;
            transition: opacity 0.2s;
        }
        .qr-page-button:hover {
            opacity: 0.9;
        }

        .feature-page { padding: 0.5rem; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .placeholder-page {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; height: 100%; color: var(--text-secondary);
        }
        .placeholder-page i { font-size: 4rem; margin-bottom: 1rem; color: var(--border-color); }
        .placeholder-page h3 { font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-dark); }
        
        .student-table { width: 100%; border-collapse: collapse; background: var(--secondary-color); border-radius: 12px; overflow: hidden; }
        .student-table th, .student-table td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); }
        .student-table th { background-color: var(--primary-color); color: var(--text-light); font-weight: 600; }
        .student-table tr:nth-child(even) { background-color: #f9fafb; }
        .student-table td:first-child { text-align: center; }
        
        .student-list-summary, .management-summary {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--secondary-color);
            border-radius: 12px;
            display: flex;
            justify-content: space-around;
            font-weight: 600;
            color: var(--text-dark);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        #qr-scanner-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8); z-index: 3000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #qr-reader { width: 90%; max-width: 400px; background: white; border-radius: 12px; overflow: hidden; }
        #close-qr-scanner {
            color: white; font-size: 1.5rem; cursor: pointer;
            margin-top: 1rem; background: var(--primary-color);
            padding: 0.5rem 1.5rem; border-radius: 8px;
        }
        
        .bottom-nav {
            background: var(--secondary-color); display: flex; justify-content: space-around;
            align-items: center;
            padding: 0.5rem 0; border-top: 1px solid var(--primary-color); z-index: 100; flex-shrink: 0;
            height: 65px;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center; color: var(--text-secondary);
            text-decoration: none; padding: 0.2rem; flex-grow: 1; cursor: pointer; position: relative;
        }
        .nav-item.active, .nav-item:hover { color: var(--primary-color); }
        .nav-item i { font-size: 1.2rem; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.7rem; font-weight: 600; }
        
        #qr-scan-button-nav {
            width: 60px; height: 60px; background: linear-gradient(45deg, var(--primary-color), #4a70e0);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-size: 1.8rem;
            cursor: pointer; transform: translateY(-20px);
            border: 4px solid var(--background-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s ease;
        }
        #qr-scan-button-nav:hover { transform: translateY(-23px) scale(1.05); }

        .notification-badge {
            position: absolute; top: -2px; right: 15px; background-color: var(--notification-color);
            color: white; border-radius: 50%; width: 20px; height: 20px;
            font-size: 12px; font-weight: bold; display: flex; align-items: center;
            justify-content: center; border: 2px solid var(--secondary-color);
        }

        .toast {
            position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%);
            padding: 0.8rem 1.5rem; border-radius: 10px; color: white;
            font-weight: 600; z-index: 4000; opacity: 0;
            transition: opacity 0.4s, bottom 0.4s; pointer-events: none;
        }
        .toast.show { opacity: 1; bottom: 110px; }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--error-color); }
        
        .update-banner {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-dark);
            color: var(--text-light);
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.5s ease;
        }
        .update-banner.show {
            opacity: 1;
        }
        .update-banner button {
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-family: 'Kantumruy Pro', sans-serif;
            font-weight: 600;
            cursor: pointer;
        }

        /* --- Professional Profile Page Styles --- */
        .profile-page-v2 {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        .profile-card {
            background-color: var(--secondary-color);
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .profile-card-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #5477e8 100%);
            padding: 2rem;
            text-align: center;
            position: relative;
            color: var(--text-light);
        }
        .profile-avatar {
            width: 110px;
            height: 110px;
            border-radius: 50%;
            border: 4px solid var(--secondary-color);
            margin: 0 auto 1rem auto;
            background-color: var(--background-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: var(--primary-color);
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .profile-card-header h2 {
            font-size: 1.6rem;
            font-weight: 700;
            margin: 0;
        }
        .profile-card-header p {
            font-size: 1rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        .profile-card-body {
            padding: 1.5rem;
        }
        .details-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
        }
        .profile-details-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.25rem;
        }
        @media (min-width: 640px) {
            .profile-details-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            background-color: #f9fafb;
            padding: 1rem;
            border-radius: 10px;
        }
        .detail-item .icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            width: 40px;
            text-align: center;
        }
        .detail-item .text-content span {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.2rem;
        }
        .detail-item .text-content div {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        /* --- Score Input Page Styles --- */
        .score-input-page { display: flex; flex-direction: column; gap: 1rem; }
        .score-selectors, .score-export-section { display: flex; gap: 1rem; }
        .score-selectors select, .score-export-section select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'Kantumruy Pro', sans-serif;
            font-size: 0.9rem;
            background-color: white;
        }
        .score-export-section button {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Kantumruy Pro', sans-serif;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }
        .score-input-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .score-input-card {
            display: grid;
            grid-template-columns: auto 1fr auto auto; 
            align-items: center;
            gap: 1rem;
            background-color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .score-input-card .student-no { font-weight: 700; color: var(--text-secondary); }
        .score-input-card .student-name { font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .score-input-card .student-gender { 
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-right: 30px; 
        }
        .score-input-card .score-input {
            width: 60px;
            padding: 0.5rem;
            text-align: center;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .score-submit-container {
            margin-top: 1rem;
            padding: 0.5rem;
        }
        #submit-scores-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: linear-gradient(45deg, var(--success-color), #10a971);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            transition: all 0.2s ease-in-out;
        }
        
        /* --- Ranking Page Styles --- */
        .ranking-page { display: flex; flex-direction: column; gap: 1rem; }
        .ranking-selectors { display: flex; gap: 1rem; }
        .ranking-selectors select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'Kantumruy Pro', sans-serif;
            font-size: 0.9rem;
            background-color: white;
        }
        .ranking-list { width: 100%; border-collapse: collapse; background: var(--secondary-color); border-radius: 12px; overflow: hidden; }
        .ranking-list th, .ranking-list td { padding: 0.75rem 0.5rem; text-align: center; border-bottom: 1px solid var(--border-color); }
        .ranking-list th { background-color: var(--primary-color); color: var(--text-light); font-weight: 600; }
        .ranking-list tr:nth-child(even) { background-color: #f9fafb; }
        .ranking-list tr.student-rank-row { cursor: pointer; }
        .ranking-list td.student-name-cell { text-align: left; }
        .ranking-list td.total-score-cell { color: var(--primary-color); font-weight: bold; }
        .ranking-list td.rank-cell { color: var(--error-color); font-weight: bold; }
        
        .score-details-row { display: none; }
        .score-details-row.active { display: table-row; }
        .score-details-cell { padding: 1rem !important; background-color: #f0f2f5; text-align: left; }
        .score-details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 1rem;
            font-size: 1rem;
        }
        .score-details-grid span { display: block; text-align: left; }
        .score-details-grid strong { color: var(--text-dark); }
        .score-details-grid .rank strong { color: var(--error-color); }
        .score-details-grid .average strong { color: var(--primary-color); }

        /* --- Attendance Page Styles --- */
        .attendance-page {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 0;
        }
        .attendance-header {
            background-color: var(--secondary-color);
            padding: 0.75rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 1rem;
        }
        .student-attendance-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .student-attendance-card {
            display: grid;
            grid-template-columns: auto 1fr auto auto auto auto;
            align-items: center;
            gap: 0.5rem;
            background-color: var(--secondary-color);
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border-left: 5px solid var(--border-color);
            transition: border-left-color 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .student-attendance-card.status-present { border-left-color: var(--status-present-color); }
        .student-attendance-card.status-absent { border-left-color: var(--status-absent-color); }
        .student-attendance-card.status-leave { border-left-color: var(--status-leave-color); }
        
        .student-attendance-card .student-no {
            font-weight: 700;
            color: var(--text-secondary);
        }
        .student-attendance-card .student-name-att {
            font-weight: 600;
            text-align: left;
        }
        .student-attendance-card .student-gender-att {
            color: var(--text-secondary);
            font-size: 0.9rem;
            justify-self: center;
        }
        .attendance-btn {
            padding: 0.25rem;
            width: 40px;
            font-size: 0.8rem;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: #f9fafb;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .attendance-btn.active.present {
            background-color: var(--status-present-color);
            border-color: var(--status-present-color);
            color: white;
        }
        .attendance-btn.active.absent {
            background-color: var(--status-absent-color);
            border-color: var(--status-absent-color);
            color: white;
        }
        .attendance-btn.active.leave {
            background-color: var(--status-leave-color);
            border-color: var(--status-leave-color);
            color: white;
        }
        .attendance-submit-container {
             margin-top: 1.5rem;
             padding: 0 0.5rem;
        }
        #submit-attendance-btn {
            width: 100%;
            padding: 1rem;
            font-size: 1.1rem;
            font-weight: 700;
            color: white;
            background: var(--primary-color);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(57, 99, 222, 0.3);
        }
        #submit-attendance-btn:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
        }

        /* --- Manage Teachers/Students Page Styles --- */
        .manage-page {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .manage-header {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        .manage-header.teacher-header {
            flex-wrap: nowrap;
        }
        .search-input-container {
            position: relative;
            flex-grow: 1;
        }
        .search-input-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }
        #teacher-search-input, #student-search-input {
            width: 100%;
            padding: 0.8rem 1rem 0.8rem 2.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'Kantumruy Pro', sans-serif;
            font-size: 0.9rem;
        }
        .add-btn {
            padding: 0.8rem 1.2rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            font-family: 'Kantumruy Pro', sans-serif;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }
        .class-filter-container {
            flex-grow: 1;
        }
        #class-filter {
             width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            font-family: 'Kantumruy Pro', sans-serif;
            font-size: 0.9rem;
        }
        .item-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .item-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .item-card-photo {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: var(--text-secondary);
            flex-shrink: 0;
            overflow: hidden;
        }
        .item-card-photo img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .item-card-details {
            flex-grow: 1;
        }
        .item-card-details h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-dark);
        }
        .item-card-details p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .item-card-actions {
            display: flex;
            gap: 0.75rem;
        }
        .item-card-actions button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: var(--background-color);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1rem;
        }

        /* --- Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 3500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 16px;
            width: 90%;
            max-width: 450px;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .modal-header h3 {
            font-size: 1.4rem;
            color: var(--text-dark);
        }
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }
        .modal-body .form-group {
            margin-bottom: 1rem;
        }
        .modal-body .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .modal-body .form-group input, .modal-body .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 2rem;
        }
        .modal-footer button {
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        .modal-footer .save-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-footer .cancel-btn {
            background-color: var(--background-color);
            color: var(--text-secondary);
        }

        /* --- Class Management Styles --- */
        .class-management-page {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
        }
        .class-card {
            background: var(--secondary-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.07);
            display: flex;
            flex-direction: column;
        }
        .class-card h3 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        .class-card-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        .class-card-details p {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-secondary);
        }
        .class-card-details p i {
            width: 20px;
            text-align: center;
        }
        .class-card-actions button {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            font-weight: 700;
            border-radius: 8px;
            cursor: pointer;
        }


    </style>
</head>
<body>

    <div id="app-wrapper" class="page-container">
        <div id="full-page-loader" class="loader-overlay hidden">
            <div class="loader-content">
                <div class="loader-spinner">
                    <div class="dot1"></div>
                    <div class="dot2"></div>
                    <div class="dot3"></div>
                </div>
                <p class="loader-text-main">សូមមេត្តារង់ចាំ</p>
                <p id="loader-sub-text" class="loader-text-sub">ប្រព័ន្ធកំពុងទាញយកទិន្នន័យ...</p>
            </div>
        </div>

        <div id="login-container" class="login-container">
            <div class="login-header">
                <img src="icons/appicon.PNG" alt="School Logo" class="login-logo">
                <h1 class="login-school-name">វិទ្យាល័យ ហ៊ុន សែន ក្រាំងស្រម៉</h1>
                <h2 class="login-app-title">ប្រព័ន្ធគ្រប់គ្រងសាលារៀន</h2>
            </div>
            <div class="login-form-container">
                <p class="login-prompt">សូមចូលគណនីរបស់អ្នកដើម្បីបន្ត</p>
                <form id="login-form" class="login-form" onsubmit="return false;">
                    <div class="input-group">
                        <i class="fa-solid fa-user"></i>
                        <input id="username" type="text" placeholder="ឈ្មោះគណនី" required>
                    </div>
                    <div class="input-group">
                        <i class="fa-solid fa-lock"></i>
                        <input id="password" type="password" placeholder="ពាក្យសម្ងាត់" required>
                    </div>
                    <div id="login-error" class="hidden"></div>
                    <div class="login-button-wrapper">
                        <button id="login-button" type="submit">
                            <span class="btn-text">ចូលប្រើ</span>
                            <div class="spinner hidden"></div>
                        </button>
                    </div>
                </form>
            </div>
            <footer class="login-footer">
                <p>បង្កើតកម្មវិធីដោយ: លោកគ្រូ ទឿន ដាលី</p>
            </footer>
        </div>

        <div id="app-container" class="page-container hidden">
            <div id="main-page" class="page center">
                <header class="header">
                    <div class="header-side">
                        <i id="back-button" class="fa-solid fa-arrow-left hidden"></i>
                        <img id="school-logo-img" src="icons/appicon.PNG" alt="School Logo" class="logo">
                    </div>
                    <div class="school-title-block">
                        <div id="main-title-block">
                            <h1>វិទ្យាល័យ ហ៊ុន សែន ក្រាំងស្រម៉</h1>
                            <p>ឆ្នាំសិក្សា ២០២៤-២០២៥</p>
                        </div>
                        <div id="page-title-block" class="hidden">
                            <h1 id="page-title"></h1>
                        </div>
                    </div>
                    <div class="header-side">
                        <i id="refresh-button" class="fa-solid fa-rotate-right"></i>
                        <i id="qr-scan-button-header" class="fa-solid fa-qrcode"></i>
                    </div>
                </header>

                <main id="main-content">
                    <div id="pull-to-refresh"></div>
                    <div id="dashboard-content">
                        <div id="user-profile-bar" class="user-profile-bar" data-feature="User Profile">
                            <div class="user-info">
                                <div id="user-photo" class="user-photo"></div>
                                <div class="user-details">
                                    <h2 id="user-name"></h2>
                                    <p id="user-role"></p>
                                </div>
                            </div>
                            <div id="teacher-stats" class="teacher-stats">
                                <div class="stat-item">
                                    <span id="total-students" class="count"></span>
                                    <span>សិស្សសរុប</span>
                                </div>
                                <div class="stat-item">
                                    <span id="female-students" class="count"></span>
                                    <span>សិស្សស្រី</span>
                                </div>
                            </div>
                        </div>
                        <div id="teacher-menu" class="feature-menu hidden">
                            <div class="menu-item" data-feature="Student List"><i class="fa-solid fa-users"></i><span>បញ្ជីឈ្មោះសិស្ស</span></div>
                            <div class="menu-item" data-feature="Attendance"><i class="fa-solid fa-user-check"></i><span>វត្តមាន</span></div>
                            <div class="menu-item" data-feature="Score Input"><i class="fa-solid fa-file-pen"></i><span>បញ្ចូលពិន្ទុ</span></div>
                            <div class="menu-item" data-feature="Homework"><i class="fa-solid fa-book-medical"></i><span>កិច្ចការផ្ទះ</span></div>
                            <div class="menu-item" data-feature="Month Ranking"><i class="fa-solid fa-trophy"></i><span>ចំណាត់ថ្នាក់</span></div>
                            <div class="menu-item" data-feature="Report"><i class="fa-solid fa-file-invoice"></i><span>របាយការណ៍</span></div>
                            <div class="menu-item" data-feature="Timetable"><i class="fa-solid fa-calendar-days"></i><span>កាលវិភាគ</span></div>
                            <div class="menu-item" data-feature="Announcements"><i class="fa-solid fa-bullhorn"></i><span>សេចក្តីជូនដំណឹង</span></div>
                            <div class="menu-item" data-feature="Settings"><i class="fa-solid fa-gear"></i><span>ការកំណត់</span></div>
                        </div>
                        <div id="admin-menu" class="feature-menu hidden">
                             <div class="menu-item" data-feature="Teacher QR Attendance"><i class="fa-solid fa-chalkboard-user"></i><span>QR វត្តមានគ្រូ</span></div>
                            <div class="menu-item" data-feature="Announcements"><i class="fa-solid fa-bullhorn"></i><span>សេចក្តីជូនដំណឹង</span></div>
                            <div class="menu-item" data-feature="Manage Teachers"><i class="fa-solid fa-user-gear"></i><span>គ្រប់គ្រងគ្រូ</span></div>
                            <div class="menu-item" data-feature="Manage Students"><i class="fa-solid fa-users-gear"></i><span>គ្រប់គ្រងសិស្ស</span></div>
                            <div class="menu-item" data-feature="Class Management"><i class="fa-solid fa-school"></i><span>គ្រប់គ្រងថ្នាក់</span></div>
                            <div class="menu-item" data-feature="School Settings"><i class="fa-solid fa-sliders"></i><span>ការកំណត់សាលា</span></div>
                            <div class="menu-item" data-feature="System Logs"><i class="fa-solid fa-file-waveform"></i><span>កំណត់ត្រាប្រព័ន្ធ</span></div>
                        </div>
                    </div>
                    <div id="feature-page-content"></div>
                </main>

                <nav class="bottom-nav">
                    <a class="nav-item active" data-nav="home"> <i class="fa-solid fa-house"></i> <span>ទំព័រដើម</span> </a>
                    <a id="logout-button-nav" class="nav-item"> <i class="fa-solid fa-right-from-bracket"></i> <span>ចាកចេញ</span> </a>
                    <div id="qr-scan-button-nav">
                        <i class="fa-solid fa-qrcode"></i>
                    </div>
                    <a class="nav-item" data-nav="notifications"> 
                        <i class="fa-regular fa-bell"></i> 
                        <span>ការជូនដំណឹង</span>
                        <div id="notification-badge" class="notification-badge hidden"></div>
                    </a>
                    <a class="nav-item" data-nav="profile"> <i class="fa-solid fa-user"></i> <span>គណនី</span> </a>
                </nav>
            </div>
        </div>
        
        <div id="qr-scanner-container" class="hidden">
            <div id="qr-reader"></div>
            <button id="close-qr-scanner">បិទម៉ាស៊ីនស្កេន</button>
        </div>

        <div id="teacher-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="teacher-modal-title"></h3>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <form id="teacher-form">
                    <div class="modal-body">
                        <input type="hidden" id="is-new-teacher" value="true">
                         <div class="form-group">
                            <label for="teacher-fullname">ឈ្មោះពេញ</label>
                            <input type="text" id="teacher-fullname" required>
                        </div>
                        <div class="form-group">
                            <label for="teacher-username">ឈ្មោះគណនី</label>
                            <input type="text" id="teacher-username" required>
                        </div>
                        <div class="form-group">
                            <label for="teacher-password">ពាក្យសម្ងាត់</label>
                            <input type="password" id="teacher-password">
                        </div>
                        <div class="form-group">
                            <label for="teacher-subject">មុខវិជ្ជា</label>
                            <input type="text" id="teacher-subject">
                        </div>
                         <div class="form-group">
                            <label for="teacher-classgrade">ថ្នាក់ដែលបានចាត់តាំង</label>
                            <input type="text" id="teacher-classgrade">
                        </div>
                         <div class="form-group">
                            <label for="teacher-photourl">URL រូបថត (ស្រេចចិត្ត)</label>
                            <input type="text" id="teacher-photourl">
                        </div>
                         <div class="form-group">
                            <label for="teacher-email">អ៊ីមែល (ស្រេចចិត្ត)</label>
                            <input type="email" id="teacher-email">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-btn">បោះបង់</button>
                        <button type="submit" class="save-btn">រក្សាទុក</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="student-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="student-modal-title"></h3>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <form id="student-form">
                    <div class="modal-body">
                        <input type="hidden" id="is-new-student" value="true">
                         <div class="form-group">
                            <label for="student-id">អត្តលេខសិស្ស</label>
                            <input type="text" id="student-id" required>
                        </div>
                        <div class="form-group">
                            <label for="student-fullname">ឈ្មោះពេញ</label>
                            <input type="text" id="student-fullname" required>
                        </div>
                        <div class="form-group">
                            <label for="student-gender">ភេទ</label>
                            <select id="student-gender">
                                <option value="ប្រុស">ប្រុស</option>
                                <option value="ស្រី">ស្រី</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-dob">ថ្ងៃខែឆ្នាំកំណើត</label>
                            <input type="date" id="student-dob">
                        </div>
                         <div class="form-group">
                            <label for="student-classgrade">ថ្នាក់</label>
                            <input type="text" id="student-classgrade">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-btn">បោះបង់</button>
                        <button type="submit" class="save-btn">រក្សាទុក</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="assign-teacher-modal" class="modal-overlay">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="assign-teacher-modal-title"></h3>
                    <button class="modal-close-btn">&times;</button>
                </div>
                <form id="assign-teacher-form">
                    <div class="modal-body">
                        <input type="hidden" id="assign-class-name">
                        <div class="form-group">
                            <label for="teacher-select">ជ្រើសរើសគ្រូ</label>
                            <select id="teacher-select"></select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="cancel-btn">បោះបង់</button>
                        <button type="submit" class="save-btn">រក្សាទុក</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="confirm-modal" class="modal-overlay">
            <div class="modal-content" style="max-width: 380px; text-align: center;">
                <div class="modal-body">
                    <i class="fa-solid fa-triangle-exclamation" style="font-size: 3rem; color: var(--error-color); margin-bottom: 1rem;"></i>
                    <h3 id="confirm-modal-title" style="font-size: 1.2rem; margin-bottom: 0.5rem;"></h3>
                    <p id="confirm-modal-text" style="color: var(--text-secondary);"></p>
                </div>
                <div class="modal-footer" style="justify-content: center;">
                    <button type="button" class="cancel-btn">បោះបង់</button>
                    <button type="button" class="save-btn" id="confirm-modal-btn" style="background-color: var(--error-color);">យល់ព្រមលុប</button>
                </div>
            </div>
        </div>

    </div>

    <div id="toast-notification" class="toast"></div>
    <div id="update-notification" class="update-banner hidden">
        <span>កំណែថ្មីបានត្រៀមរួចរាល់</span>
        <button id="reload-button">ធ្វើបច្ចុប្បន្នភាព</button>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
             // !!! IMPORTANT !!! 
             // THIS URL MUST BE UPDATED AFTER YOU DEPLOY THE SCRIPT
            const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby2bXGyCA8iAWcLVauw4E0xVxorMVEVDC13e9D91QsSOdrMrVzWveAt3VccooH2LXPEpA/exec";

             // --- UI Elements ---
            const loginContainer = document.getElementById('login-container');
            const appContainer = document.getElementById('app-container');
            const loginForm = document.getElementById('login-form');
            const loginButton = document.getElementById('login-button');
            const loginSpinner = loginButton.querySelector('.spinner');
            const loginError = document.getElementById('login-error');
            const fullPageLoader = document.getElementById('full-page-loader');
            const loaderSubText = document.getElementById('loader-sub-text');
            
            const mainContent = document.getElementById('main-content');
            const dashboardContent = document.getElementById('dashboard-content');
            const featurePageContent = document.getElementById('feature-page-content');
            const backButton = document.getElementById('back-button');
            const pullToRefreshIndicator = document.getElementById('pull-to-refresh');
            
            const userProfileBar = document.getElementById('user-profile-bar');
            const userPhotoContainer = document.getElementById('user-photo');
            const userNameEl = document.getElementById('user-name');
            const userRoleEl = document.getElementById('user-role');
            const teacherStats = document.getElementById('teacher-stats');
            const teacherMenu = document.getElementById('teacher-menu');
            const adminMenu = document.getElementById('admin-menu');
            const notificationBadge = document.getElementById('notification-badge');

            // --- QR Scanner Elements ---
            const qrScannerContainer = document.getElementById('qr-scanner-container');
            const closeQrScannerButton = document.getElementById('close-qr-scanner');
            let html5QrCode;

            // --- PWA Update Elements ---
            let newWorker;
            const updateNotification = document.getElementById('update-notification');
            const reloadButton = document.getElementById('reload-button');

            // --- Toast Notification ---
            const toast = document.getElementById('toast-notification');
            function showToast(message, type = 'success') {
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => { toast.className = 'toast'; }, 4000);
            }

            // --- API Fetch Utility ---
            async function apiFetch(action, options = {}) {
                try {
                    let response;
                    if (options.method === 'POST') {
                        response = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            mode: 'cors',
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            body: JSON.stringify({ action: action, ...options.body }),
                            redirect: 'follow'
                        });
                    } else {
                        const url = new URL(SCRIPT_URL);
                        url.searchParams.set('action', action);
                        url.searchParams.set('t', new Date().getTime());
                        if (options.params) {
                            for (const key in options.params) {
                                url.searchParams.set(key, options.params[key]);
                            }
                        }
                        response = await fetch(url, { method: 'GET', mode: 'cors' });
                    }

                    if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    return result;
                } catch (error) {
                    console.error(`API Fetch Error (${action}):`, error);
                    showToast(error.message || 'Failed to fetch data.', 'error');
                    throw error;
                }
            }


            // --- Session & Login/Logout Logic ---
            async function checkSession() {
                const userCredentials = localStorage.getItem('schoolAppCredentials');
                if (userCredentials) {
                    const { username, password } = JSON.parse(userCredentials);
                    await refreshAndShowDashboard(username, password);
                } else {
                    loginContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            }

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                loginButton.disabled = true;
                loginButton.classList.add('loading');
                loginSpinner.classList.remove('hidden');
                loginError.classList.add('hidden');
                
                try {
                    const result = await apiFetch('login', { params: { username, password } });
                    localStorage.setItem('schoolAppCredentials', JSON.stringify({ username, password }));
                    localStorage.setItem('schoolAppUser', JSON.stringify(result.data));
                    await setupDashboard(result.data);
                    loginContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                } catch (error) {
                    loginError.textContent = 'ឈ្មោះគណនី ឬពាក្យសម្ងាត់មិនត្រឹមត្រូវទេ';
                    loginError.classList.remove('hidden');
                } finally {
                    loginButton.disabled = false;
                    loginButton.classList.remove('loading');
                    loginSpinner.classList.add('hidden');
                }
            });
            
            function handleLogout() {
                localStorage.clear();
                appContainer.classList.add('hidden');
                loginContainer.classList.remove('hidden');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                loginError.classList.add('hidden');
            }
            
            async function refreshAndShowDashboard(username, password) {
                fullPageLoader.classList.remove('hidden');
                loginContainer.classList.add('hidden');
                try {
                    const result = await apiFetch('login', { params: { username, password } });
                    localStorage.setItem('schoolAppUser', JSON.stringify(result.data));
                    await setupDashboard(result.data);
                    appContainer.classList.remove('hidden');
                } catch(error) {
                    handleLogout();
                } finally {
                    fullPageLoader.classList.add('hidden');
                }
            }

            async function setupDashboard(data) {
                userNameEl.textContent = data.FullName;
                userPhotoContainer.innerHTML = '';
                notificationBadge.classList.add('hidden');

                if (data.Role === 'admin') {
                    userRoleEl.textContent = "អ្នកគ្រប់គ្រងប្រព័ន្ធ";
                    teacherStats.classList.add('hidden');
                    teacherMenu.classList.add('hidden');
                    adminMenu.classList.remove('hidden');
                    if (data.PhotoURL) {
                        const img = document.createElement('img');
                        img.src = data.PhotoURL;
                        img.alt = "Profile Photo";
                        userPhotoContainer.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'fa-solid fa-user-shield';
                        userPhotoContainer.appendChild(icon);
                    }
                } else { // Teacher role
                    userRoleEl.textContent = `ថ្នាក់: ${data.ClassGrade}`;
                    teacherStats.classList.remove('hidden');
                    teacherMenu.classList.remove('hidden');
                    adminMenu.classList.add('hidden');
                    if (data.PhotoURL) {
                        const img = document.createElement('img');
                        img.src = data.PhotoURL;
                        img.alt = "Profile Photo";
                        userPhotoContainer.appendChild(img);
                    } else {
                        const icon = document.createElement('i');
                        icon.className = 'fa-solid fa-user-tie';
                        userPhotoContainer.appendChild(icon);
                    }
                    document.getElementById('total-students').textContent = data.TotalStudents || '-';
                    document.getElementById('female-students').textContent = data.FemaleStudents || '-';
                    await checkNewAnnouncements();
                }
                 history.replaceState({ page: 'dashboard' }, 'Dashboard', '#dashboard');
            }

            // --- Notification Logic ---
            async function checkNewAnnouncements() {
                try {
                    const { data: announcements } = await apiFetch('getAnnouncements');
                    if (!announcements || announcements.length === 0) return;
                    const lastSeenTimestamp = localStorage.getItem('lastSeenAnnouncement') || 0;
                    const newAnnouncements = announcements.filter(ann => new Date(ann.timestamp || ann.Timestamp).getTime() > lastSeenTimestamp);
                    if (newAnnouncements.length > 0) {
                        notificationBadge.textContent = newAnnouncements.length;
                        notificationBadge.classList.remove('hidden');
                    } else {
                        notificationBadge.classList.add('hidden');
                    }
                } catch (error) { console.error("Could not check for new announcements:", error); }
            }

            function markAnnouncementsAsRead() {
                apiFetch('getAnnouncements').then(({data: announcements}) => {
                    if (announcements && announcements.length > 0) {
                        const latestTimestamp = new Date(announcements[0].timestamp || announcements[0].Timestamp).getTime();
                        localStorage.setItem('lastSeenAnnouncement', latestTimestamp);
                        notificationBadge.classList.add('hidden');
                    }
                });
            }

            // --- Page Navigation ---
            function showDashboard() {
                dashboardContent.classList.remove('hidden');
                featurePageContent.innerHTML = '';
                featurePageContent.classList.add('hidden');
                document.getElementById('main-title-block').classList.remove('hidden');
                document.getElementById('page-title-block').classList.add('hidden');
                backButton.classList.add('hidden');
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                const homeNav = document.querySelector('.nav-item[data-nav="home"]');
                if(homeNav) homeNav.classList.add('active');
            }
            
            function showFeaturePage(title, content) {
                document.getElementById('page-title').textContent = title;
                featurePageContent.innerHTML = '';
                featurePageContent.appendChild(content);
                dashboardContent.classList.add('hidden');
                featurePageContent.classList.remove('hidden');
                document.getElementById('main-title-block').classList.add('hidden');
                document.getElementById('page-title-block').classList.remove('hidden');
                backButton.classList.remove('hidden');
            }
            
            async function navigateTo(page, push = true) {
                if (push) {
                     history.pushState({ page: page }, '', `#${page}`);
                }

                // Update nav-item active state
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                let targetNav = 'home';
                if (page === 'Announcements') targetNav = 'notifications';
                else if (page === 'User Profile') targetNav = 'profile';
                
                const activeNavItem = document.querySelector(`.nav-item[data-nav="${targetNav}"]`);
                if(activeNavItem) activeNavItem.classList.add('active');


                if (page === 'dashboard' || page === null) {
                    showDashboard();
                    return;
                }
                
                await handleFeatureClick(page);
            }


            backButton.addEventListener('click', () => history.back());

            // --- QR Scanner Logic ---
            const onScanSuccess = (decodedText, decodedResult) => {
                stopQrScanner();

                if (decodedText.startsWith('TEACHER_ATTENDANCE:')) {
                    const qrSecret = decodedText.split(':')[1];
                    
                    showToast('Verifying location...', 'success');

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            const userData = JSON.parse(localStorage.getItem('schoolAppUser'));
                            
                            apiFetch('recordTeacherAttendance', {
                                method: 'POST',
                                body: {
                                    qrSecret: qrSecret,
                                    userId: userData.Username,
                                    latitude: latitude,
                                    longitude: longitude
                                }
                            }).then(result => {
                                showToast(result.message, 'success');
                            }).catch(error => {
                                // Error toast is already shown by apiFetch
                            });
                        },
                        (error) => {
                            showToast('Could not get location. Please enable location services.', 'error');
                            console.error("Geolocation error:", error);
                        },
                        { enableHighAccuracy: true }
                    );

                } else {
                    // Fallback for student QR codes (or other types)
                    const now = new Date();
                    const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    showToast(`វត្តមានសម្រាប់ ${decodedText} បានកត់ត្រាម៉ោង ${timeString}`, 'success');
                    // This part remains as it was, potentially for student QR codes.
                    // Note: 'recordAttendance' is not a valid POST action in the provided code.gs
                    apiFetch('recordAttendance', {
                        method: 'POST',
                        body: { userId: decodedText, timestamp: now.toISOString() }
                    });
                }
            };

            const onScanFailure = (error) => {};

            function startQrScanner() {
                qrScannerContainer.classList.remove('hidden');
                if (!html5QrCode) {
                    html5QrCode = new Html5Qrcode("qr-reader");
                }
                html5QrCode.start(
                    { facingMode: "environment" },
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess,
                    onScanFailure
                ).catch(err => {
                    showToast('មិនអាចបើកកាមេរ៉ាបានទេ។', 'error');
                    console.error("Cannot start QR scanner", err);
                    stopQrScanner();
                });
            }

            function stopQrScanner() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {}).catch(err => {});
                }
                qrScannerContainer.classList.add('hidden');
            }
            
            closeQrScannerButton.addEventListener('click', stopQrScanner);


            // --- Feature Implementations ---
            async function handleFeatureClick(feature) {
                const userData = JSON.parse(localStorage.getItem('schoolAppUser'));
                if (!userData) return;

                fullPageLoader.classList.remove('hidden');
                try {
                    let pageContent, pageTitle;
                    loaderSubText.textContent = `កំពុងទាញយក ${feature}...`;
                    switch (feature) {
                        case 'User Profile':
                            pageContent = createProfilePage(userData);
                            pageTitle = 'ព័ត៌មានផ្ទាល់ខ្លួន';
                            break;
                        case 'Announcements':
                            const { data: announcements } = await apiFetch('getAnnouncements');
                            pageContent = createAnnouncementsPage(announcements, userData.Role);
                            pageTitle = 'សេចក្តីជូនដំណឹង';
                            if (userData.Role === 'teacher') markAnnouncementsAsRead();
                            break;
                        case 'Student List':
                             const { data: students } = await apiFetch('getStudentInfo');
                             pageContent = createStudentListPage(students, userData.ClassGrade);
                             pageTitle = 'បញ្ជីឈ្មោះសិស្ស';
                             break;
                        case 'Attendance':
                             const { data: studentInfo } = await apiFetch('getStudentInfo');
                             const { data: attendanceRecords } = await apiFetch('getAttendanceData', { params: { classGrade: userData.ClassGrade } });
                             const studentsForAttendance = studentInfo.filter(s => s.ClassGrade === userData.ClassGrade);
                             pageContent = createAttendancePage(studentsForAttendance, attendanceRecords, userData.ClassGrade);
                             pageTitle = 'វត្តមាន';
                             break;
                        case 'Score Input':
                             const { data: scoreStudentList } = await apiFetch('getStudentInfo');
                             const studentsForScores = scoreStudentList.filter(s => s.ClassGrade === userData.ClassGrade);
                             
                             const defaultMonthForScore = new Date().toLocaleString('en-US', { month: 'short' });
                             const { data: subjectList } = await apiFetch('getSubjectListForMonth', { params: { month: defaultMonthForScore } });
                             
                             pageContent = createScoreInputPage(studentsForScores, subjectList, userData.ClassGrade);
                             pageTitle = 'បញ្ចូលពិន្ទុ';
                             break;
                        case 'Month Ranking':
                             const defaultMonthForRank = new Date().toLocaleString('en-US', { month: 'short' });
                             const { data: rankingData } = await apiFetch('getMonthRanking', { params: { classGrade: userData.ClassGrade, month: defaultMonthForRank } });
                             pageContent = createRankingPage(rankingData.students, rankingData.subjects, userData.ClassGrade);
                             pageTitle = 'ចំណាត់ថ្នាក់ប្រចាំខែ';
                             break;
                        case 'Teacher QR Attendance':
                             pageContent = createTeacherQrPage();
                             pageTitle = 'QR វត្តមានគ្រូ';
                             break;
                        case 'Manage Teachers':
                            const { data: teachers } = await apiFetch('getAllTeachers');
                            pageContent = createManageTeachersPage(teachers);
                            pageTitle = 'គ្រប់គ្រងគ្រូ';
                            break;
                        case 'Manage Students':
                            const { data: studentsForManage } = await apiFetch('getAllStudents');
                            pageContent = createManageStudentsPage(studentsForManage);
                            pageTitle = 'គ្រប់គ្រងសិស្ស';
                            break;
                        case 'Class Management':
                            const { data: classes } = await apiFetch('getAllClasses');
                            const { data: allTeachers } = await apiFetch('getAllTeachers');
                            pageContent = createClassManagementPage(classes, allTeachers);
                            pageTitle = 'គ្រប់គ្រងថ្នាក់';
                            break;
                        default:
                            pageContent = createPlaceholderPage(feature);
                            pageTitle = feature;
                            break;
                    }
                    if(pageContent) {
                        showFeaturePage(pageTitle, pageContent);
                    }
                } catch (error) {
                    showToast('Failed to load feature.', 'error');
                    showDashboard();
                } finally {
                    fullPageLoader.classList.add('hidden');
                    loaderSubText.textContent = "ប្រព័ន្ធកំពុងទាញយកទិន្នន័យ...";
                }
            }
            
            function createPlaceholderPage(featureName) {
                const container = document.createElement('div');
                container.className = 'feature-page placeholder-page';
                container.innerHTML = `
                    <i class="fa-solid fa-person-digging"></i>
                    <h3>មុខងារ "${featureName}"</h3>
                    <p>កំពុងតែត្រូវបានបង្កើតឡើង។ សូមអរគុណ!</p>
                `;
                return container;
            }

            function createProfilePage(userData) {
                const container = document.createElement('div');
                container.className = 'feature-page profile-page-v2';

                const photoHTML = userData.PhotoURL 
                    ? `<img src="${userData.PhotoURL}" alt="Profile Photo">` 
                    : `<i class="fa-solid ${userData.Role === 'admin' ? 'fa-user-shield' : 'fa-user-tie'}"></i>`;

                const roleText = userData.Role === 'admin' ? 'អ្នកគ្រប់គ្រងប្រព័ន្ធ' : `គ្រូបង្រៀនថ្នាក់ ${userData.ClassGrade}`;

                let teacherDetails = '';
                if (userData.Role === 'teacher') {
                    teacherDetails = `
                        <div class="detail-item">
                            <i class="icon fa-solid fa-book-open-reader"></i>
                            <div class="text-content"><span>មុខវិជ្ជា</span><div>${userData.Subject || 'N/A'}</div></div>
                        </div>
                        <div class="detail-item">
                            <i class="icon fa-solid fa-chalkboard-user"></i>
                            <div class="text-content"><span>ថ្នាក់បង្រៀន</span><div>${userData.ClassGrade || 'N/A'}</div></div>
                        </div>
                        <div class="detail-item">
                            <i class="icon fa-solid fa-users"></i>
                            <div class="text-content"><span>សិស្សសរុប</span><div>${userData.TotalStudents || 0} នាក់</div></div>
                        </div>
                        <div class="detail-item">
                            <i class="icon fa-solid fa-venus"></i>
                            <div class="text-content"><span>សិស្សស្រី</span><div>${userData.FemaleStudents || 0} នាក់</div></div>
                        </div>
                        <div class="detail-item">
                            <i class="icon fa-solid fa-envelope"></i>
                            <div class="text-content"><span>អ៊ីមែល</span><div>${userData.Email || 'មិនមាន'}</div></div>
                        </div>
                    `;
                }

                container.innerHTML = `
                    <div class="profile-card">
                        <div class="profile-card-header">
                            <div class="profile-avatar">${photoHTML}</div>
                            <h2>${userData.FullName}</h2>
                            <p>${roleText}</p>
                        </div>
                        <div class="profile-card-body">
                            <h3 class="details-section-title">ព័ត៌មានលម្អិត</h3>
                            <div class="profile-details-grid">
                                ${teacherDetails}
                            </div>
                        </div>
                    </div>
                `;
                return container;
            }

            function createAnnouncementsPage(announcements, role) {
                const container = document.createElement('div');
                container.className = 'feature-page announcements-page';
                
                const style = document.createElement('style');
                style.textContent = `
                    .announcements-page { display: flex; flex-direction: column; gap: 1.5rem; }
                    .announcement-form { background: var(--secondary-color); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
                    .announcement-form h3 { font-size: 1.25rem; font-weight: 700; color: var(--text-dark); margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; }
                    .announcement-form h3 i { color: var(--primary-color); }
                    .form-group { margin-bottom: 1.25rem; }
                    .form-group label { display: block; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; font-size: 0.9rem; }
                    .form-group input, .form-group textarea {
                        width: 100%; padding: 0.85rem 1rem; border: 1px solid var(--border-color);
                        border-radius: 8px; font-family: 'Kantumruy Pro', sans-serif; font-size: 1rem;
                        transition: border-color 0.2s, box-shadow 0.2s;
                    }
                    .form-group input:focus, .form-group textarea:focus {
                        outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(57, 99, 222, 0.2);
                    }
                    .form-group textarea { min-height: 120px; resize: vertical; }
                    .form-actions { text-align: center; margin-top: 1.5rem; }
                    .form-actions button {
                        background: linear-gradient(45deg, var(--primary-color), #4a70e0); color: white;
                        border: none; padding: 0.8rem 2.5rem; border-radius: 50px;
                        cursor: pointer; font-weight: 700; font-size: 1rem;
                        transition: transform 0.2s, box-shadow 0.2s;
                        display: inline-flex; align-items: center; gap: 0.75rem;
                        box-shadow: 0 4px 15px rgba(57, 99, 222, 0.2);
                    }
                    .form-actions button:hover {
                        transform: translateY(-3px);
                        box-shadow: 0 6px 20px rgba(57, 99, 222, 0.4);
                    }
                    .announcement-list { display: flex; flex-direction: column; gap: 1rem; }
                    .announcement-item { background: var(--secondary-color); padding: 1.25rem; border-radius: 12px; border-left: 5px solid var(--primary-color); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
                    .announcement-subject { font-weight: 700; font-size: 1.1rem; color: var(--text-dark); margin-bottom: 0.5rem; }
                    .announcement-message { color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.6; white-space: pre-wrap; }
                    .announcement-meta { font-size: 0.8rem; color: #99a3b3; text-align: right; }
                `;
                container.appendChild(style);

                if (role === 'admin') {
                    const form = document.createElement('form');
                    form.className = 'announcement-form';
                    form.onsubmit = saveAnnouncement;
                    form.innerHTML = `
                        <h3><i class="fa-solid fa-bullhorn"></i> បង្កើតសេចក្តីជូនដំណឹងថ្មី</h3>
                        <div class="form-group">
                            <label for="announcement-subject">ប្រធានបទ</label>
                            <input type="text" id="announcement-subject" placeholder="ឧ: កិច្ចប្រជុំមាតាបិតា" required>
                        </div>
                        <div class="form-group">
                            <label for="announcement-message">ខ្លឹមសារ</label>
                            <textarea id="announcement-message" placeholder="សូមបញ្ចូលខ្លឹមសារនៅទីនេះ..." required></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit">
                                <i class="fa-solid fa-paper-plane"></i>
                                <span>ផ្ញើសារ</span>
                            </button>
                        </div>
                    `;
                    container.appendChild(form);
                }
                
                const listContainer = document.createElement('div');
                listContainer.className = 'announcement-list';
                container.appendChild(listContainer);

                if (!announcements || announcements.length === 0) {
                    listContainer.innerHTML = '<p>មិនមានសេចក្តីជូនដំណឹងថ្មីទេ។</p>';
                } else {
                    announcements.forEach(ann => {
                        const item = document.createElement('div');
                        item.className = 'announcement-item';
                        
                        const subject = ann.subject || ann.Subject || 'គ្មានប្រធានបទ';
                        const message = ann.message || ann.Message || '';
                        const sender = ann.sender || ann.Sender || 'មិនស្គាល់';
                        const timestamp = ann.timestamp || ann.Timestamp;

                        const dateObj = new Date(timestamp);
                        const dateString = dateObj.toLocaleDateString('km-KH', { day: 'numeric', month: 'long', year: 'numeric' });
                        const timeString = dateObj.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
                        const dateTime = `${dateString}, ${timeString}`;
                        
                        item.innerHTML = `<div class="announcement-subject">${subject}</div><p class="announcement-message">${message}</p><div class="announcement-meta">ដោយ: ${sender} - ${dateTime}</div>`;
                        listContainer.appendChild(item);
                    });
                }
                return container;
            }
            
            function createStudentListPage(allStudents, teacherClassGrade) {
                const container = document.createElement('div');
                container.className = 'feature-page';
                
                const studentsInClass = allStudents.filter(s => s.ClassGrade === teacherClassGrade);
                const totalStudents = studentsInClass.length;
                const femaleStudents = studentsInClass.filter(s => String(s.Gender).trim() === 'ស').length;

                const summary = document.createElement('div');
                summary.className = 'student-list-summary';
                summary.innerHTML = `
                    <span>សិស្សសរុប: ${totalStudents}នាក់</span>
                    <span>សិស្សស្រី: ${femaleStudents}នាក់</span>
                `;
                container.appendChild(summary);

                if (!studentsInClass || studentsInClass.length === 0) {
                    container.innerHTML += `<div class="placeholder-page"><i class="fa-solid fa-users-slash"></i><h3>មិនមានសិស្ស</h3><p>មិនមានទិន្នន័យសិស្សសម្រាប់ថ្នាក់នេះទេ។</p></div>`;
                    return container;
                }
                const table = document.createElement('table');
                table.className = 'student-table';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ល.រ.</th>
                            <th>ឈ្មោះសិស្ស</th>
                            <th>ភេទ</th>
                            <th>ថ្ងៃខែឆ្នាំកំណើត</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${studentsInClass.map((student, index) => {
                            let dob = student['Date of Birth'];
                            if (dob && typeof dob === 'string' && dob.includes('T')) {
                                try {
                                    const date = new Date(dob);
                                    if (!isNaN(date.getTime())) {
                                        dob = new Intl.DateTimeFormat('en-GB').format(date);
                                    }
                                } catch (e) { console.error("Could not parse date:", dob); }
                            }
                            return `
                            <tr>
                                <td>${index + 1}</td>
                                <td>${student['Student Name']}</td>
                                <td>${student.Gender}</td>
                                <td>${dob}</td>
                            </tr>
                        `}).join('')}
                    </tbody>
                `;
                container.appendChild(table);

                return container;
            }

            function toKhmerDateString(date) {
                const days = ['អាទិត្យ', 'ច័ន្ទ', 'អង្គារ', 'ពុធ', 'ព្រហស្បតិ៍', 'សុក្រ', 'សៅរ៍'];
                const months = ['មករា', 'កុម្ភៈ', 'មីនា', 'មេសា', 'ឧសភា', 'មិថុនា', 'កក្កដា', 'សីហា', 'កញ្ញា', 'តុលា', 'វិច្ឆិកា', 'ធ្នូ'];
                const khmerNumerals = ['០', '១', '២', '៣', '៤', '៥', '៦', '៧', '៨', '៩'];

                const toKhmerNumber = (num) => String(num).split('').map(digit => khmerNumerals[parseInt(digit)]).join('');

                const dayOfWeek = days[date.getDay()];
                const dayOfMonth = toKhmerNumber(date.getDate());
                const month = months[date.getMonth()];
                const year = toKhmerNumber(date.getFullYear());

                return `ថ្ងៃ${dayOfWeek} ទី${dayOfMonth} ខែ${month} ឆ្នាំ${year}`;
            }

            function createAttendancePage(students, attendanceRecords, classGrade) {
                const container = document.createElement('div');
                container.className = 'attendance-page';

                const today = new Date();
                const dateString = toKhmerDateString(today);

                const header = document.createElement('div');
                header.className = 'attendance-header';
                header.textContent = `វត្តមានសិស្ស: ${dateString}`;
                container.appendChild(header);

                const list = document.createElement('div');
                list.className = 'student-attendance-list';
                
                if (!students || students.length === 0) {
                    list.innerHTML = `<div class="placeholder-page"><i class="fa-solid fa-users-slash"></i><h3>មិនមានសិស្ស</h3><p>មិនមានទិន្នន័យសិស្សសម្រាប់ថ្នាក់នេះទេ។</p></div>`;
                } else {
                    students.forEach((student, index) => {
                        if (!student || !student['Student Name']) {
                            return; 
                        }

                        const card = document.createElement('div');
                        card.className = 'student-attendance-card';
                        card.dataset.studentId = student['Student Name']; 
                        
                        const dayOfMonth = today.getDate();
                        const record = attendanceRecords.find(r => r['Student Name'] === student['Student Name']);
                        let statusFromServer = record ? record[dayOfMonth.toString()] : 'P';
                        
                        let activeStatus = 'មក';
                        if (statusFromServer === 'A') activeStatus = 'អវ';
                        else if (statusFromServer === 'L') activeStatus = 'ច្បាប់';
                        
                        let statusClass = 'present';
                        if (activeStatus === 'អវ') statusClass = 'absent';
                        else if (activeStatus === 'ច្បាប់') statusClass = 'leave';
                        card.classList.add(`status-${statusClass}`);

                        card.innerHTML = `
                            <span class="student-no">${index + 1}</span>
                            <span class="student-name-att">${student['Student Name']}</span>
                            <span class="student-gender-att">${student.Gender}</span>
                            <button class="attendance-btn present ${activeStatus === 'មក' ? 'active' : ''}" data-status="មក">មក</button>
                            <button class="attendance-btn absent ${activeStatus === 'អវ' ? 'active' : ''}" data-status="អវ">អវ</button>
                            <button class="attendance-btn leave ${activeStatus === 'ច្បាប់' ? 'active' : ''}" data-status="ច្បាប់">ច្បាប់</button>
                        `;
                        list.appendChild(card);
                    });
                }
                container.appendChild(list);

                const submitContainer = document.createElement('div');
                submitContainer.className = 'attendance-submit-container';
                submitContainer.innerHTML = `<button id="submit-attendance-btn">ចុះវត្តមាន</button>`;
                container.appendChild(submitContainer);

                list.addEventListener('click', (event) => {
                    const button = event.target.closest('.attendance-btn');
                    if (!button) return;

                    const card = button.closest('.student-attendance-card');
                    
                    card.querySelectorAll('.attendance-btn').forEach(btn => btn.classList.remove('active', 'present', 'absent', 'leave'));
                    
                    const status = button.dataset.status;
                    let statusClass = '';
                    if (status === 'មក') statusClass = 'present';
                    else if (status === 'អវ') statusClass = 'absent';
                    else if (status === 'ច្បាប់') statusClass = 'leave';

                    button.classList.add('active', statusClass);
                    
                    card.classList.remove('status-present', 'status-absent', 'status-leave');
                    card.classList.add(`status-${statusClass}`);
                });

                container.querySelector('#submit-attendance-btn').addEventListener('click', (event) => {
                    const submitBtn = event.target;
                    submitBtn.textContent = 'កំពុងរក្សាទុក...';
                    submitBtn.disabled = true;

                    const attendanceData = [];
                    container.querySelectorAll('.student-attendance-card').forEach(card => {
                        const studentId = card.dataset.studentId;
                        const activeBtn = card.querySelector('.attendance-btn.active');
                        const status = activeBtn ? activeBtn.dataset.status : 'មក';
                        attendanceData.push({ studentId, status });
                    });
                    
                    saveBulkAttendance(attendanceData, classGrade, submitBtn);
                });

                return container;
            }
            
            function createScoreInputPage(students, subjects, classGrade) {
                const container = document.createElement('div');
                container.className = 'feature-page score-input-page';

                const monthOptions = [
                    { value: 'Jan', text: 'មករា' }, { value: 'Feb', text: 'កុម្ភៈ' },
                    { value: 'Mar', text: 'មីនា' }, { value: 'Apr', text: 'មេសា' },
                    { value: 'May', text: 'ឧសភា' }, { value: 'Jun', text: 'មិថុនា' },
                    { value: 'Jul', text: 'កក្កដា' }, { value: 'Aug', text: 'សីហា' },
                    { value: 'Sep', text: 'កញ្ញា' }, { value: 'Oct', text: 'តុលា' },
                    { value: 'Nov', text: 'វិច្ឆិកា' }, { value: 'Dec', text: 'ធ្នូ' },
                    { value: 'S1_Final', text: 'ប្រឡងឆមាសទី១' },
                    { value: 'S2_Final', text: 'ប្រឡងឆមាសទី២' },
                ];
                
                let selectorsHTML = `
                    <div class="score-export-section">
                         <select id="export-month-selector">
                            <option value="" disabled selected>ជ្រើសរើសខែទាញយក</option>
                            ${monthOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                        </select>
                        <button id="export-scores-btn">ទាញយក</button>
                    </div>
                    <div class="score-selectors">
                        <select id="month-selector">
                            <option value="" disabled selected>ជ្រើសរើសខែ</option>
                            ${monthOptions.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
                        </select>
                        <select id="subject-selector">
                             <option value="" disabled selected>ជ្រើសរើសមុខវិជ្ជា</option>
                            ${subjects.map(sub => `<option value="${sub}">${sub}</option>`).join('')}
                        </select>
                    </div>
                `;
                
                let studentListHTML = '<div class="score-input-list">';
                students.forEach((student, index) => {
                    studentListHTML += `
                        <div class="score-input-card" data-student-id="${student['Student Name']}">
                            <span class="student-no">${index + 1}</span>
                            <span class="student-name">${student['Student Name']}</span>
                            <span class="student-gender">${student.Gender}</span>
                            <input type="number" class="score-input" placeholder="ពិន្ទុ">
                        </div>
                    `;
                });
                studentListHTML += '</div>';

                const submitHTML = `
                    <div class="score-submit-container">
                        <button id="submit-scores-btn">រក្សាទុកពិន្ទុ</button>
                    </div>
                `;

                container.innerHTML = selectorsHTML + studentListHTML + submitHTML;

                const scoreList = container.querySelector('.score-input-list');
                const submitBtn = container.querySelector('#submit-scores-btn');

                scoreList.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const inputs = Array.from(scoreList.querySelectorAll('.score-input'));
                        const currentIndex = inputs.indexOf(event.target);
                        const nextIndex = currentIndex + 1;
                        if (nextIndex < inputs.length) {
                            inputs[nextIndex].focus();
                        } else {
                            submitBtn.focus();
                        }
                    }
                });

                submitBtn.addEventListener('click', () => {
                    saveScores(container, classGrade);
                });

                container.querySelector('#export-scores-btn').addEventListener('click', async (event) => {
                    const exportBtn = event.target;
                    const exportMonth = container.querySelector('#export-month-selector').value;
                    if (!exportMonth) {
                        showToast('សូមជ្រើសរើសខែសម្រាប់ទាញយក', 'error');
                        return;
                    }
                    
                    exportBtn.textContent = 'កំពុងទាញយក...';
                    exportBtn.disabled = true;
                    
                    const sheetName = `Scores_${exportMonth}`;
                    
                    try {
                        const { data } = await apiFetch('exportScoresByClass', { params: { sheetName, classGrade } });
                        if (data.url) {
                            window.open(data.url, '_blank');
                            showToast('ទាញយកជោគជ័យ!', 'success');
                        } else {
                            showToast('Could not get export URL.', 'error');
                        }
                    } catch(e) {
                        // Error is already shown by apiFetch
                    } finally {
                        exportBtn.textContent = 'ទាញយក';
                        exportBtn.disabled = false;
                    }
                });

                return container;
            }
            
            function createRankingPage(students, subjects, classGrade) {
                const container = document.createElement('div');
                container.className = 'feature-page ranking-page';
                
                const monthOptions = [
                    { value: 'Jan', text: 'មករា' }, { value: 'Feb', text: 'កុម្ភៈ' },
                    { value: 'Mar', text: 'មីនា' }, { value: 'Apr', text: 'មេសា' },
                    { value: 'May', text: 'ឧសភា' }, { value: 'Jun', text: 'មិថុនា' },
                    { value: 'Jul', text: 'កក្កដា' }, { value: 'Aug', text: 'សីហា' },
                    { value: 'Sep', text: 'កញ្ញា' }, { value: 'Oct', text: 'តុលា' },
                    { value: 'Nov', text: 'វិច្ឆិកា' }, { value: 'Dec', text: 'ធ្នូ' },
                    { value: 'S1_Final', text: 'ឆមាសទី១' },
                    { value: 'S2_Final', text: 'ឆមាសទី២' },
                ];
                
                const currentMonth = new Date().toLocaleString('en-US', { month: 'short' });

                let selectorsHTML = `
                    <div class="ranking-selectors">
                        <select id="ranking-month-selector">
                            ${monthOptions.map(opt => `<option value="${opt.value}" ${opt.value === currentMonth ? 'selected' : ''}>${opt.text}</option>`).join('')}
                        </select>
                        <select id="ranking-sort-selector">
                            <option value="rank">តម្រៀបចំណាត់ថ្នាក់</option>
                            <option value="name">តម្រៀបតាមឈ្មោះ</option>
                        </select>
                    </div>
                `;

                const tableContainer = document.createElement('div');
                tableContainer.innerHTML = `
                    <table class="ranking-list">
                        <thead>
                            <tr>
                                <th>ល.រ</th>
                                <th style="text-align: left;">ឈ្មោះសិស្ស</th>
                                <th>ភេទ</th>
                                <th>សរុប</th>
                                <th>ចំណាត់ថ្នាក់</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                `;
                const tableBody = tableContainer.querySelector('tbody');
                
                function renderList(data) {
                    tableBody.innerHTML = '';
                     if (!data || data.length === 0) {
                        const row = tableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 5;
                        cell.innerHTML = `<div class="placeholder-page" style="height: 200px;"><i class="fa-solid fa-chart-simple"></i><h3>No Ranking Data</h3><p>No scores have been entered for this month.</p></div>`;
                        return;
                    }

                    data.forEach((student, index) => {
                        const mainRow = tableBody.insertRow();
                        mainRow.className = 'student-rank-row';

                        mainRow.innerHTML = `
                            <td>${index + 1}</td>
                            <td class="student-name-cell">${student['Student Name']}</td>
                            <td>${student.Gender}</td>
                            <td class="total-score-cell">${student.Total || '-'}</td>
                            <td class="rank-cell">${student.Rank || '-'}</td>
                        `;

                        const detailsRow = tableBody.insertRow();
                        detailsRow.className = 'score-details-row';
                        const detailsCell = detailsRow.insertCell();
                        detailsCell.colSpan = 5;
                        
                        let scoreDetailsHTML = '<div class="score-details-grid">';
                        scoreDetailsHTML += `<span class="detail-item average">មធ្យមភាគ: <strong>${student.Average ? parseFloat(student.Average).toFixed(2) : '-'}</strong></span>`;
                        scoreDetailsHTML += `<span class="detail-item rank">ចំណាត់ថ្នាក់: <strong>${student.Rank || '-'}</strong></span>`;
                        
                        subjects.forEach(subject => {
                            const score = student.Scores[subject] || '-';
                            scoreDetailsHTML += `<span>${subject}: <strong>${score}</strong></span>`;
                        });
                        scoreDetailsHTML += '</div>';
                        detailsCell.innerHTML = scoreDetailsHTML;

                        mainRow.addEventListener('click', () => {
                            detailsRow.classList.toggle('active');
                        });
                    });
                }

                renderList(students);
                container.innerHTML = selectorsHTML;
                container.appendChild(tableContainer);
                
                async function updateRankingView() {
                    const month = container.querySelector('#ranking-month-selector').value;
                    const sortBy = container.querySelector('#ranking-sort-selector').value;
                    try {
                        const { data } = await apiFetch('getMonthRanking', { params: { classGrade, month, sortBy } });
                        renderList(data.students);
                    } catch (e) {
                         tableBody.innerHTML = `<tr><td colspan="5"><div class="placeholder-page" style="height: 200px;"><i class="fa-solid fa-chart-simple"></i><h3>No Ranking Data</h3><p>${e.message}</p></div></td></tr>`;
                    }
                }

                container.querySelector('#ranking-month-selector').addEventListener('change', updateRankingView);
                container.querySelector('#ranking-sort-selector').addEventListener('change', updateRankingView);

                return container;
            }


            async function saveBulkAttendance(attendanceData, classGrade, submitBtn) {
                try {
                    await apiFetch('recordBulkAttendance', {
                        method: 'POST',
                        body: { attendanceData, classGrade }
                    });
                    showToast('បានរក្សាទុកវត្តមានដោយជោគជ័យ!', 'success');
                } catch (error) {
                    showToast('Error saving attendance.', 'error');
                } finally {
                    submitBtn.textContent = 'ចុះវត្តមាន';
                    submitBtn.disabled = false;
                }
            }
            
            async function saveScores(container, classGrade) {
                const submitBtn = container.querySelector('#submit-scores-btn');
                submitBtn.textContent = 'កំពុងរក្សាទុក...';
                submitBtn.disabled = true;

                const scoresData = [];
                const month = container.querySelector('#month-selector').value;
                const subject = container.querySelector('#subject-selector').value;

                if (!month || !subject) {
                    showToast('សូមជ្រើសរើសខែ និងមុខវិជ្ជា', 'error');
                    submitBtn.textContent = 'រក្សាទុកពិន្ទុ';
                    submitBtn.disabled = false;
                    return;
                }

                container.querySelectorAll('.score-input-card').forEach(card => {
                    const studentId = card.dataset.studentId;
                    const score = card.querySelector('.score-input').value;
                    if (score) {
                        scoresData.push({ studentId, score });
                    }
                });

                try {
                    await apiFetch('saveScores', {
                        method: 'POST',
                        body: { month, subject, classGrade, scores: scoresData }
                    });
                    showToast('ពិន្ទុត្រូវបានរក្សាទុកដោយជោគជ័យ!', 'success');
                    container.querySelectorAll('.score-input').forEach(input => input.value = '');
                } catch (error) {
                    showToast('Error saving scores.', 'error');
                } finally {
                    submitBtn.textContent = 'រក្សាទុកពិន្ទុ';
                    submitBtn.disabled = false;
                }
            }


            async function saveAnnouncement(event) {
                event.preventDefault();
                const button = event.target.querySelector('button');
                const subjectInput = document.getElementById('announcement-subject');
                const messageInput = document.getElementById('announcement-message');
                const userData = JSON.parse(localStorage.getItem('schoolAppUser'));
                button.disabled = true;
                button.innerHTML = '<span>កំពុងផ្ញើ...</span>';
                try {
                    await apiFetch('saveNotification', {
                        method: 'POST',
                        body: { 
                            subject: subjectInput.value, 
                            message: messageInput.value, 
                            sender: userData.FullName 
                        }
                    });
                    showToast('បានផ្ញើសេចក្តីជូនដំណឹងដោយជោគជ័យ!', 'success');
                    subjectInput.value = '';
                    messageInput.value = '';
                    handleFeatureClick('Announcements');
                } catch (error) {
                    showToast('ការផ្ញើបានបរាជ័យ។', 'error');
                } finally {
                    button.disabled = false;
                    button.innerHTML = '<i class="fa-solid fa-paper-plane"></i> <span>ផ្ញើសារ</span>';
                }
            }
            
            function createTeacherQrPage() {
                const container = document.createElement('div');
                container.className = 'feature-page';
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h3>QR Code សម្រាប់វត្តមានគ្រូ</h3>
                        <div id="teacher-qrcode-display" style="margin: 2rem auto; width: 256px; height: 256px; background: white; padding: 1rem; border-radius: 12px; display:flex; align-items:center; justify-content:center;">
                           <p>សូមមេត្តារង់ចាំ...</p>
                        </div>
                        <button id="save-qr-btn" class="qr-page-button" style="background-color: var(--success-color); color: white;">
                            <i class="fa-solid fa-download"></i> <span>រក្សាទុកជា​រូបភាព</span>
                        </button>
                        <button id="regen-qr-btn" class="qr-page-button" style="background-color: #fff5f5; color: var(--error-color); border: 1px solid var(--error-color);">
                            <i class="fa-solid fa-arrows-rotate"></i> <span>បង្កើត QR Code ថ្មី</span>
                        </button>
                        <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">ការបង្កើត QR Code ថ្មីនឹងធ្វើឱ្យ QR Code ចាស់ប្រើការលែងកើត។</p>
                    </div>
                `;

                const qrContainer = container.querySelector('#teacher-qrcode-display');
                
                function generateQR(secret) {
                    qrContainer.innerHTML = '';
                    new QRCode(qrContainer, {
                        text: `TEACHER_ATTENDANCE:${secret}`,
                        width: 240,
                        height: 240,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }

                apiFetch('getTeacherQRSettings').then(response => {
                    generateQR(response.data.secret);
                });

                container.querySelector('#save-qr-btn').addEventListener('click', () => {
                    const qrElement = container.querySelector('#teacher-qrcode-display');
                    showToast('កំពុងបង្កើតរូបភាព...', 'success');
                    html2canvas(qrElement, { 
                        backgroundColor: null, // Make background transparent
                        scale: 2 
                    }).then(canvas => {
                        const link = document.createElement('a');
                        link.download = 'Teacher-Attendance-QR.png';
                        link.href = canvas.toDataURL('image/png');
                        link.click();
                    }).catch(err => {
                        showToast('Error creating image.', 'error');
                        console.error('html2canvas error:', err);
                    });
                });

                container.querySelector('#regen-qr-btn').addEventListener('click', async () => {
                   if (confirm('Are you sure you want to generate a new QR code? The old one will no longer work.')) {
                       try {
                           const response = await apiFetch('regenerateTeacherQRSecret');
                           generateQR(response.data.newSecret);
                           showToast('New QR Code generated successfully!', 'success');
                       } catch(e) {
                           // error shown by apiFetch
                       }
                   }
                });

                return container;
            }

            function createManageTeachersPage(teachers) {
                const container = document.createElement('div');
                container.className = 'feature-page manage-page';
                
                const header = document.createElement('div');
                header.className = 'manage-header teacher-header';
                header.innerHTML = `
                    <div class="search-input-container">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="teacher-search-input" placeholder="ស្វែងរកឈ្មោះគ្រូ...">
                    </div>
                    <button class="add-btn" id="add-teacher-btn"><i class="fa-solid fa-plus"></i> បន្ថែមគ្រូ</button>
                `;
                container.appendChild(header);

                const summary = document.createElement('div');
                summary.className = 'management-summary';
                const totalTeachers = teachers.length;
                summary.innerHTML = `<span>គ្រូសរុប: ${totalTeachers}នាក់</span>`;
                container.appendChild(summary);

                const teacherListContainer = document.createElement('div');
                teacherListContainer.className = 'item-list';
                container.appendChild(teacherListContainer);

                let allTeachers = teachers;

                function renderTeacherList(filteredTeachers) {
                    teacherListContainer.innerHTML = '';
                    if (!filteredTeachers || filteredTeachers.length === 0) {
                        teacherListContainer.innerHTML = `<div class="placeholder-page" style="height: 200px;"><i class="fa-solid fa-chalkboard-user"></i><h3>មិនមានទិន្នន័យគ្រូទេ</h3></div>`;
                        return;
                    }
                    filteredTeachers.forEach(teacher => {
                        const card = document.createElement('div');
                        card.className = 'item-card';
                        card.dataset.username = teacher.Username;

                        const photoHTML = teacher.PhotoURL 
                            ? `<img src="${teacher.PhotoURL}" alt="Photo">`
                            : `<i class="fa-solid fa-user-tie"></i>`;

                        card.innerHTML = `
                            <div class="item-card-photo">${photoHTML}</div>
                            <div class="item-card-details">
                                <h4 style="margin-bottom: 3px;">${teacher.FullName}</h4>
                                <p>មុខវិជ្ជា: ${teacher.Subject || 'មិនមាន'} &nbsp;&nbsp; ថ្នាក់: ${teacher.ClassGrade || 'មិនមាន'}</p>
                            </div>
                            <div class="item-card-actions">
                                <button class="edit-btn"><i class="fa-solid fa-pencil"></i></button>
                                <button class="delete-btn"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                        teacherListContainer.appendChild(card);
                    });
                }

                renderTeacherList(allTeachers);

                // Search functionality
                container.querySelector('#teacher-search-input').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filtered = allTeachers.filter(t => t.FullName.toLowerCase().includes(searchTerm));
                    renderTeacherList(filtered);
                });

                // Modal Handling
                const modal = document.getElementById('teacher-modal');
                const modalTitle = document.getElementById('teacher-modal-title');
                const teacherForm = document.getElementById('teacher-form');
                
                function showModal() { modal.classList.add('show'); }
                function hideModal() { modal.classList.remove('show'); }

                container.querySelector('#add-teacher-btn').addEventListener('click', () => {
                    teacherForm.reset();
                    document.getElementById('is-new-teacher').value = 'true';
                    document.getElementById('teacher-username').readOnly = false;
                    modalTitle.textContent = 'បន្ថែមគ្រូថ្មី';
                    showModal();
                });

                modal.querySelector('.modal-close-btn').addEventListener('click', hideModal);
                modal.querySelector('.cancel-btn').addEventListener('click', hideModal);
                
                teacherListContainer.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');

                    if (editBtn) {
                        const username = editBtn.closest('.item-card').dataset.username;
                        const teacher = allTeachers.find(t => t.Username === username);
                        
                        document.getElementById('is-new-teacher').value = 'false';
                        modalTitle.textContent = 'កែប្រែព័ត៌មានគ្រូ';
                        
                        document.getElementById('teacher-fullname').value = teacher.FullName || '';
                        document.getElementById('teacher-username').value = teacher.Username || '';
                        document.getElementById('teacher-username').readOnly = true;
                        document.getElementById('teacher-password').value = '';
                        document.getElementById('teacher-password').placeholder = 'ទុកឱ្យនៅទំនេរដើម្បីរក្សាពាក្យសម្ងាត់ចាស់';
                        document.getElementById('teacher-subject').value = teacher.Subject || '';
                        document.getElementById('teacher-classgrade').value = teacher.ClassGrade || '';
                        document.getElementById('teacher-photourl').value = teacher.PhotoURL || '';
                        document.getElementById('teacher-email').value = teacher.Email || '';

                        showModal();
                    }

                    if (deleteBtn) {
                        const username = deleteBtn.closest('.item-card').dataset.username;
                        showConfirmModal(
                            'បញ្ជាក់ការលុប',
                            `តើអ្នកពិតជាចង់លុបគណនីគ្រូឈ្មោះ "${username}" មែនទេ?`,
                            async () => {
                                fullPageLoader.classList.remove('hidden');
                                try {
                                    await apiFetch('deleteTeacher', { method: 'POST', body: { username } });
                                    showToast('បានលុបគ្រូដោយជោគជ័យ។', 'success');
                                    const { data: updatedTeachers } = await apiFetch('getAllTeachers');
                                    allTeachers = updatedTeachers;
                                    renderTeacherList(allTeachers);
                                } catch (error) {
                                    // Error toast is shown by apiFetch
                                } finally {
                                    fullPageLoader.classList.add('hidden');
                                }
                            }
                        );
                    }
                });

                teacherForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    fullPageLoader.classList.remove('hidden');

                    const isNew = document.getElementById('is-new-teacher').value === 'true';
                    const teacherData = {
                        FullName: document.getElementById('teacher-fullname').value,
                        Username: document.getElementById('teacher-username').value,
                        Password: document.getElementById('teacher-password').value,
                        Subject: document.getElementById('teacher-subject').value,
                        ClassGrade: document.getElementById('teacher-classgrade').value,
                        PhotoURL: document.getElementById('teacher-photourl').value,
                        Email: document.getElementById('teacher-email').value,
                        Role: 'teacher' // Always set role to teacher
                    };

                    if (isNew && !teacherData.Password) {
                        showToast('ត្រូវតែបញ្ចូលពាក្យសម្ងាត់សម្រាប់គ្រូថ្មី។', 'error');
                        fullPageLoader.classList.add('hidden');
                        return;
                    }

                    try {
                        await apiFetch('saveTeacher', { method: 'POST', body: { teacherData, isNew } });
                        const successMessage = isNew ? 'បានបន្ថែមគ្រូថ្មីដោយជោគជ័យ។' : 'បានកែប្រែព័ត៌មានគ្រូដោយជោគជ័យ។';
                        showToast(successMessage, 'success');
                        hideModal();
                        const { data: updatedTeachers } = await apiFetch('getAllTeachers');
                        allTeachers = updatedTeachers;
                        renderTeacherList(allTeachers);
                    } catch (error) {
                       // Error toast is shown by apiFetch
                    } finally {
                        fullPageLoader.classList.add('hidden');
                    }
                });


                return container;
            }

             function createManageStudentsPage(students) {
                const container = document.createElement('div');
                container.className = 'feature-page manage-page';
                
                const header = document.createElement('div');
                header.className = 'manage-header';
                
                const uniqueClasses = [...new Set(students.map(s => s.ClassGrade).filter(Boolean))].sort();

                header.innerHTML = `
                    <div class="search-input-container">
                        <i class="fa-solid fa-search"></i>
                        <input type="text" id="student-search-input" placeholder="ស្វែងរកឈ្មោះសិស្ស...">
                    </div>
                    <div class="class-filter-container">
                        <select id="class-filter">
                            <option value="">គ្រប់ថ្នាក់</option>
                            ${uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('')}
                        </select>
                    </div>
                    <button class="add-btn" id="add-student-btn"><i class="fa-solid fa-plus"></i> បន្ថែមសិស្ស</button>
                `;
                container.appendChild(header);

                const summary = document.createElement('div');
                summary.className = 'management-summary';
                container.appendChild(summary);

                const studentListContainer = document.createElement('div');
                studentListContainer.className = 'item-list';
                container.appendChild(studentListContainer);

                let allStudents = students;

                function renderStudentList(filteredStudents) {
                    studentListContainer.innerHTML = '';

                    const totalStudents = filteredStudents.length;
                    const femaleStudents = filteredStudents.filter(s => String(s.Gender).trim() === 'ស្រី').length;
                    summary.innerHTML = `<span>សិស្សសរុប: ${totalStudents}នាក់</span><span>សិស្សស្រី: ${femaleStudents}នាក់</span>`;

                    if (!filteredStudents || filteredStudents.length === 0) {
                        studentListContainer.innerHTML = `<div class="placeholder-page" style="height: 200px;"><i class="fa-solid fa-users"></i><h3>មិនមានទិន្នន័យសិស្សទេ</h3></div>`;
                        return;
                    }

                    filteredStudents.forEach(student => {
                        const card = document.createElement('div');
                        card.className = 'item-card';
                        card.dataset.studentNo = student.No;

                        card.innerHTML = `
                            <div class="item-card-photo"><i class="fa-solid fa-user"></i></div>
                            <div class="item-card-details">
                                <h4 style="margin-bottom: 3px;">${student['Student Name']}</h4>
                                <p>ភេទ: ${student.Gender || 'មិនមាន'} &nbsp;&nbsp; ថ្នាក់: ${student.ClassGrade || 'មិនមាន'}</p>
                            </div>
                            <div class="item-card-actions">
                                <button class="edit-btn"><i class="fa-solid fa-pencil"></i></button>
                                <button class="delete-btn"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        `;
                        studentListContainer.appendChild(card);
                    });
                }
                
                const searchInput = container.querySelector('#student-search-input');
                const classFilter = container.querySelector('#class-filter');

                function applyFilters() {
                    const searchTerm = searchInput.value.toLowerCase();
                    const selectedClass = classFilter.value;

                    let filtered = allStudents;

                    if (selectedClass) {
                        filtered = filtered.filter(s => s.ClassGrade === selectedClass);
                    }

                    if (searchTerm) {
                        filtered = filtered.filter(s => s['Student Name'].toLowerCase().includes(searchTerm));
                    }
                    
                    renderStudentList(filtered);
                }

                searchInput.addEventListener('input', applyFilters);
                classFilter.addEventListener('change', applyFilters);

                applyFilters(); // Initial render

                // Modal Handling
                const modal = document.getElementById('student-modal');
                const modalTitle = document.getElementById('student-modal-title');
                const studentForm = document.getElementById('student-form');
                
                function showModal() { modal.classList.add('show'); }
                function hideModal() { modal.classList.remove('show'); }

                container.querySelector('#add-student-btn').addEventListener('click', () => {
                    studentForm.reset();
                    document.getElementById('is-new-student').value = 'true';
                    document.getElementById('student-id').readOnly = false;
                    modalTitle.textContent = 'បន្ថែមសិស្សថ្មី';
                    showModal();
                });

                modal.querySelector('.modal-close-btn').addEventListener('click', hideModal);
                modal.querySelector('.cancel-btn').addEventListener('click', hideModal);

                studentListContainer.addEventListener('click', async (e) => {
                    const editBtn = e.target.closest('.edit-btn');
                    const deleteBtn = e.target.closest('.delete-btn');

                    if (editBtn) {
                        const studentNo = editBtn.closest('.item-card').dataset.studentNo;
                        const student = allStudents.find(s => s.No == studentNo);
                        
                        document.getElementById('is-new-student').value = 'false';
                        modalTitle.textContent = 'កែប្រែព័ត៌មានសិស្ស';
                        
                        document.getElementById('student-id').value = student.No || '';
                        document.getElementById('student-id').readOnly = true;
                        document.getElementById('student-fullname').value = student['Student Name'] || '';
                        document.getElementById('student-gender').value = student.Gender || 'ប្រុស';
                        
                        let dob = '';
                        if (student['Date of Birth']) {
                            try {
                                const date = new Date(student['Date of Birth']);
                                if (!isNaN(date.getTime())) {
                                    dob = date.toISOString().split('T')[0];
                                }
                            } catch(err) {}
                        }
                        document.getElementById('student-dob').value = dob;
                        document.getElementById('student-classgrade').value = student.ClassGrade || '';

                        showModal();
                    }

                    if (deleteBtn) {
                        const studentNo = deleteBtn.closest('.item-card').dataset.studentNo;
                        const student = allStudents.find(s => s.No == studentNo);
                        showConfirmModal(
                            'បញ្ជាក់ការលុប',
                            `តើអ្នកពិតជាចង់លុបសិស្សឈ្មោះ "${student['Student Name']}" មែនទេ? ទិន្នន័យពិន្ទុ និងវត្តមានទាំងអស់នឹងត្រូវលុបដែរ។`,
                            async () => {
                                fullPageLoader.classList.remove('hidden');
                                try {
                                    await apiFetch('deleteStudent', { method: 'POST', body: { studentNo } });
                                    showToast('បានលុបសិស្សដោយជោគជ័យ។', 'success');
                                    const { data: updatedStudents } = await apiFetch('getAllStudents');
                                    allStudents = updatedStudents;
                                    applyFilters();
                                } catch (error) {
                                    // Error toast is shown by apiFetch
                                } finally {
                                    fullPageLoader.classList.add('hidden');
                                }
                            }
                        );
                    }
                });

                studentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    fullPageLoader.classList.remove('hidden');

                    const isNew = document.getElementById('is-new-student').value === 'true';
                    const dobValue = document.getElementById('student-dob').value;
                    const studentData = {
                        'No': document.getElementById('student-id').value,
                        'Student Name': document.getElementById('student-fullname').value,
                        'Gender': document.getElementById('student-gender').value,
                        'Date of Birth': dobValue ? new Date(dobValue) : '',
                        'ClassGrade': document.getElementById('student-classgrade').value,
                    };

                    try {
                        await apiFetch('saveStudent', { method: 'POST', body: { studentData, isNew } });
                        const successMessage = isNew ? 'បានបន្ថែមសិស្សថ្មីដោយជោគជ័យ។' : 'បានកែប្រែព័ត៌មានសិស្សដោយជោគជ័យ។';
                        showToast(successMessage, 'success');
                        hideModal();
                        const { data: updatedStudents } = await apiFetch('getAllStudents');
                        allStudents = updatedStudents;
                        applyFilters();
                    } catch (error) {
                       // Error toast is shown by apiFetch
                    } finally {
                        fullPageLoader.classList.add('hidden');
                    }
                });


                return container;
            }

            function createClassManagementPage(classes, allTeachers) {
                const container = document.createElement('div');
                container.className = 'feature-page class-management-page';

                if (!classes || classes.length === 0) {
                    container.innerHTML = `<div class="placeholder-page" style="height: 200px;"><i class="fa-solid fa-school"></i><h3>មិនមានទិន្នន័យថ្នាក់ទេ</h3></div>`;
                    return container;
                }

                classes.forEach(cls => {
                    const card = document.createElement('div');
                    card.className = 'class-card';
                    card.dataset.className = cls.name;
                    card.dataset.teacherUsername = cls.teacherUsername || '';

                    const teacherInfo = cls.teacher
                        ? `<i class="fa-solid fa-chalkboard-user"></i> គ្រូបន្ទុកថ្នាក់: ${cls.teacher}`
                        : `<i class="fa-solid fa-chalkboard-user"></i> <span style="color: var(--error-color);">មិនទាន់មានគ្រូប្រចាំថ្នាក់</span>`;

                    card.innerHTML = `
                        <h3>ថ្នាក់ទី ${cls.name}</h3>
                        <div class="class-card-details">
                            <p><i class="fa-solid fa-users"></i> សិស្សសរុប: ${cls.studentCount} នាក់</p>
                            <p><i class="fa-solid fa-venus"></i> សិស្សស្រី: ${cls.femaleStudentCount} នាក់</p>
                            <p>${teacherInfo}</p>
                        </div>
                        <div class="class-card-actions">
                            <button class="assign-teacher-btn">ចាត់តាំងគ្រូ</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
                const modal = document.getElementById('assign-teacher-modal');
                const modalTitle = document.getElementById('assign-teacher-modal-title');
                const assignForm = document.getElementById('assign-teacher-form');
                const teacherSelect = document.getElementById('teacher-select');

                function showModal() { modal.classList.add('show'); }
                function hideModal() { modal.classList.remove('show'); }
                
                modal.querySelector('.modal-close-btn').addEventListener('click', hideModal);
                modal.querySelector('.cancel-btn').addEventListener('click', hideModal);
                
                container.addEventListener('click', (e) => {
                    const assignBtn = e.target.closest('.assign-teacher-btn');
                    if (assignBtn) {
                        const card = assignBtn.closest('.class-card');
                        const className = card.dataset.className;
                        const currentTeacher = card.dataset.teacherUsername;
                        
                        document.getElementById('assign-class-name').value = className;
                        modalTitle.textContent = `ចាត់តាំងគ្រូប្រចាំថ្នាក់ ${className}`;
                        
                        teacherSelect.innerHTML = '<option value="">-- មិនចាត់តាំង --</option>';
                        allTeachers.forEach(teacher => {
                            const option = document.createElement('option');
                            option.value = teacher.Username;
                            option.textContent = teacher.FullName;
                            if (teacher.Username === currentTeacher) {
                                option.selected = true;
                            }
                            teacherSelect.appendChild(option);
                        });
                        
                        showModal();
                    }
                });

                assignForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    fullPageLoader.classList.remove('hidden');
                    
                    const classGrade = document.getElementById('assign-class-name').value;
                    const teacherUsername = teacherSelect.value;

                    try {
                        await apiFetch('assignTeacherToClass', {
                            method: 'POST',
                            body: { classGrade, teacherUsername }
                        });
                        showToast('បានចាត់តាំងគ្រូដោយជោគជ័យ', 'success');
                        hideModal();
                        // Refresh the page to show new data
                        handleFeatureClick('Class Management');
                    } catch(error) {
                        // error handled by apiFetch
                    } finally {
                        fullPageLoader.classList.add('hidden');
                    }
                });


                return container;
            }

            // --- Confirm Modal Logic ---
            const confirmModal = document.getElementById('confirm-modal');
            const confirmModalTitle = document.getElementById('confirm-modal-title');
            const confirmModalText = document.getElementById('confirm-modal-text');
            const confirmModalBtn = document.getElementById('confirm-modal-btn');
            let confirmCallback = null;

            function showConfirmModal(title, text, onConfirm) {
                confirmModalTitle.textContent = title;
                confirmModalText.textContent = text;
                confirmCallback = onConfirm;
                confirmModal.classList.add('show');
            }

            function hideConfirmModal() {
                confirmModal.classList.remove('show');
                confirmCallback = null;
            }

            confirmModal.querySelector('.cancel-btn').addEventListener('click', hideConfirmModal);
            confirmModalBtn.addEventListener('click', () => {
                if (confirmCallback) {
                    confirmCallback();
                }
                hideConfirmModal();
            });


            // --- Event Listeners ---
            document.querySelectorAll('.menu-item, #user-profile-bar').forEach(element => {
                element.addEventListener('click', () => navigateTo(element.dataset.feature));
            });
            
            document.querySelectorAll('.nav-item').forEach(element => {
                 if(element.id === 'logout-button-nav') return;
                element.addEventListener('click', (e) => {
                    const navAction = e.currentTarget.dataset.nav;
                     let page;
                     switch(navAction) {
                        case 'home': page = 'dashboard'; break;
                        case 'notifications': page = 'Announcements'; break;
                        case 'profile': page = 'User Profile'; break;
                    }
                    if (page) {
                       navigateTo(page);
                    }
                });
            });

            document.getElementById('logout-button-nav').addEventListener('click', handleLogout);
            document.getElementById('qr-scan-button-nav').addEventListener('click', startQrScanner);
            document.getElementById('qr-scan-button-header').addEventListener('click', startQrScanner);

            document.getElementById('refresh-button').addEventListener('click', async () => {
                const userCredentials = localStorage.getItem('schoolAppCredentials');
                if (userCredentials) {
                    const { username, password } = JSON.parse(userCredentials);
                    await refreshAndShowDashboard(username, password);
                }
            });
            
            window.addEventListener('popstate', (event) => {
                navigateTo(event.state ? event.state.page : 'dashboard', false);
            });

            // --- Initial Load ---
            checkSession();
        });
    </script>
</body>
</html>
